{
  "openapi": "3.1.0",
  "info": {
    "title": "Medici ASL Lazio API",
    "description": "API per la ricerca di medici di medicina generale e pediatri nelle ASL del Lazio. Utilizza parametri singoli per query semplici ed efficienti, con supporto per paginazione.",
    "version": "2.0.0",
    "contact": {
      "name": "API Support"
    }
  },
  "servers": [
    {
      "url": "https://medici-lazio-asl.vercel.app",
      "description": "Production server"
    },
    {
      "url": "http://localhost:3000",
      "description": "Development server"
    }
  ],
  "tags": [
    {
      "name": "Ricerca",
      "description": "Endpoint per la ricerca di medici"
    }
  ],
  "paths": {
    "/api/search_simple": {
      "get": {
        "summary": "Ricerca medici",
        "description": "Ricerca medici con parametri singoli (non liste). Supporta paginazione opzionale. Richiesto almeno uno tra: asl, cap, cognome, nome.",
        "operationId": "searchMediciSimpleGet",
        "tags": ["Ricerca"],
        "security": [
          {
            "cookieAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "tipo",
            "in": "query",
            "required": false,
            "description": "Tipo di medico da cercare",
            "schema": {
              "type": "string",
              "enum": ["Medicina generale", "Pediatra"],
              "default": "Medicina generale"
            }
          },
          {
            "name": "asl",
            "in": "query",
            "required": false,
            "description": "Codice ASL del Lazio. Se specificata, può soddisfare da sola il requisito 'almeno un parametro'.",
            "schema": {
              "type": "string",
              "enum": ["120201", "120202", "120203", "120204", "120205", "120206", "120112", "120111", "120110", "120109"],
              "example": "120201"
            }
          },
          {
            "name": "cap",
            "in": "query",
            "required": false,
            "description": "CAP singolo (5 cifre). Gli spazi prima e dopo saranno trimmati.",
            "schema": {
              "type": "string",
              "pattern": "^\\d{5}$",
              "example": "00173"
            }
          },
          {
            "name": "cognome",
            "in": "query",
            "required": false,
            "description": "Cognome singolo da cercare. Solo lettere, spazi o apostrofi. Gli spazi vengono normalizzati e il testo convertito in maiuscolo.",
            "schema": {
              "type": "string",
              "pattern": "^[A-Za-z'\\s]+$",
              "example": "ROSSI"
            }
          },
          {
            "name": "nome",
            "in": "query",
            "required": false,
            "description": "Nome singolo da cercare. Solo lettere, spazi o apostrofi. Gli spazi vengono normalizzati e il testo convertito in maiuscolo.",
            "schema": {
              "type": "string",
              "pattern": "^[A-Za-z'\\s]+$",
              "example": "MARIO"
            }
          },
          {
            "name": "page",
            "in": "query",
            "required": false,
            "description": "Numero di pagina da recuperare. Se specificato, restituisce solo quella pagina con informazioni di paginazione. Se omesso, restituisce tutti i risultati disponibili (fino a 10 pagine con 75 risultati ciascuna).",
            "schema": {
              "type": "integer",
              "minimum": 1,
              "example": 1
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Ricerca completata con successo",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SearchResponse"
                },
                "examples": {
                  "withPagination": {
                    "summary": "Ricerca con paginazione",
                    "value": {
                      "success": true,
                      "timestamp": "2025-01-11T12:00:00.000Z",
                      "query": {
                        "cognome": "ROSSI",
                        "asl": "120201",
                        "tipo": "Medicina generale",
                        "cap": "",
                        "nome": ""
                      },
                      "results": [
                        {
                          "nome": "MARIO",
                          "cognome": "ROSSI",
                          "asl": "Roma 1",
                          "assegnabilita": "Assegnazione libera",
                          "tipo": "Medicina generale",
                          "codiceFiscale": "RSSMRA80A01H501Z",
                          "identificativo": "12345",
                          "email": "mario.rossi@example.com",
                          "indirizzo": "Via Roma 1",
                          "luogo": "Roma",
                          "codiceDistretto": "001",
                          "descrizioneDistretto": "Distretto 1"
                        }
                      ],
                      "counters": {
                        "totali": 75,
                        "assegnabili": 25,
                        "conDeroga": 10,
                        "nonAssegnabili": 40
                      },
                      "pagination": {
                        "currentPage": 1,
                        "totalPages": 15
                      }
                    }
                  },
                  "withoutPagination": {
                    "summary": "Ricerca senza paginazione (tutti i risultati)",
                    "value": {
                      "success": true,
                      "timestamp": "2025-01-11T12:00:00.000Z",
                      "query": {
                        "cognome": "BIANCHI",
                        "asl": "",
                        "tipo": "Medicina generale",
                        "cap": "00100",
                        "nome": ""
                      },
                      "results": [
                        {
                          "nome": "LUCA",
                          "cognome": "BIANCHI",
                          "asl": "Roma 2",
                          "assegnabilita": "Con deroga",
                          "tipo": "Medicina generale",
                          "codiceFiscale": "BNCLCU85B15H501W",
                          "identificativo": "67890"
                        }
                      ],
                      "counters": {
                        "totali": 3,
                        "assegnabili": 1,
                        "conDeroga": 1,
                        "nonAssegnabili": 1
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Errore di validazione parametri",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationError"
                },
                "example": {
                  "success": false,
                  "error": "Validazione fallita: parametri non validi.",
                  "timestamp": "2025-01-11T12:00:00.000Z",
                  "validationErrors": [
                    {
                      "field": "cap",
                      "value": "123",
                      "message": "CAP deve essere di 5 cifre."
                    }
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Non autenticato",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "example": {
                  "success": false,
                  "error": "Non autenticato. Effettua il login.",
                  "timestamp": "2025-01-11T12:00:00.000Z"
                }
              }
            }
          },
          "500": {
            "description": "Errore del server",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "example": {
                  "success": false,
                  "error": "Errore interno del server.",
                  "timestamp": "2025-01-11T12:00:00.000Z"
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Ricerca medici (POST)",
        "description": "Stessa funzionalità della GET, ma con parametri nel body JSON. Utile per query complesse o per evitare limitazioni di lunghezza URL.",
        "operationId": "searchMediciSimplePost",
        "tags": ["Ricerca"],
        "security": [
          {
            "cookieAuth": []
          },
          {
            "apiKeyAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SearchRequest"
              },
              "examples": {
                "basic": {
                  "summary": "Ricerca base per cognome",
                  "value": {
                    "cognome": "ROSSI",
                    "tipo": "Medicina generale"
                  }
                },
                "withPagination": {
                  "summary": "Ricerca con paginazione",
                  "value": {
                    "cognome": "ROSSI",
                    "asl": "120201",
                    "page": 1
                  }
                },
                "byASL": {
                  "summary": "Ricerca solo per ASL",
                  "value": {
                    "asl": "120201",
                    "tipo": "Medicina generale"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Ricerca completata con successo",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SearchResponse"
                }
              }
            }
          },
          "400": {
            "description": "Errore di validazione parametri",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationError"
                }
              }
            }
          },
          "401": {
            "description": "Non autenticato",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "500": {
            "description": "Errore del server",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "cookieAuth": {
        "type": "apiKey",
        "in": "cookie",
        "name": "auth_token",
        "description": "Token JWT memorizzato nei cookie"
      },
      "apiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "Authorization",
        "description": "API Key in formato 'Bearer <token>'"
      }
    },
    "schemas": {
      "SearchRequest": {
        "type": "object",
        "description": "Parametri di ricerca. Richiesto almeno uno tra: asl, cap, cognome, nome.",
        "properties": {
          "tipo": {
            "type": "string",
            "enum": ["Medicina generale", "Pediatra"],
            "default": "Medicina generale",
            "description": "Tipo di medico"
          },
          "asl": {
            "type": "string",
            "enum": ["120201", "120202", "120203", "120204", "120205", "120206", "120112", "120111", "120110", "120109"],
            "description": "Codice ASL del Lazio",
            "example": "120201"
          },
          "cap": {
            "type": "string",
            "pattern": "^\\d{5}$",
            "description": "CAP (5 cifre)",
            "example": "00173"
          },
          "cognome": {
            "type": "string",
            "pattern": "^[A-Za-z'\\s]+$",
            "description": "Cognome da cercare",
            "example": "ROSSI"
          },
          "nome": {
            "type": "string",
            "pattern": "^[A-Za-z'\\s]+$",
            "description": "Nome da cercare",
            "example": "MARIO"
          },
          "page": {
            "type": "integer",
            "minimum": 1,
            "description": "Numero di pagina (opzionale)",
            "example": 1
          }
        }
      },
      "SearchResponse": {
        "type": "object",
        "required": ["success", "timestamp", "query", "results", "counters"],
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Indica se la ricerca è andata a buon fine",
            "example": true
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp ISO 8601 della risposta",
            "example": "2025-01-11T12:00:00.000Z"
          },
          "query": {
            "type": "object",
            "description": "Parametri di ricerca utilizzati (normalizzati)",
            "properties": {
              "cognome": {
                "type": "string"
              },
              "asl": {
                "type": "string"
              },
              "tipo": {
                "type": "string"
              },
              "cap": {
                "type": "string"
              },
              "nome": {
                "type": "string"
              }
            }
          },
          "results": {
            "type": "array",
            "description": "Array dei medici trovati",
            "items": {
              "$ref": "#/components/schemas/Medico"
            }
          },
          "counters": {
            "type": "object",
            "description": "Contatori aggregati per categoria",
            "required": ["totali", "assegnabili", "conDeroga", "nonAssegnabili"],
            "properties": {
              "totali": {
                "type": "integer",
                "description": "Numero totale di medici trovati",
                "example": 75
              },
              "assegnabili": {
                "type": "integer",
                "description": "Numero di medici con assegnazione libera",
                "example": 25
              },
              "conDeroga": {
                "type": "integer",
                "description": "Numero di medici con deroga",
                "example": 10
              },
              "nonAssegnabili": {
                "type": "integer",
                "description": "Numero di medici non assegnabili",
                "example": 40
              }
            }
          },
          "pagination": {
            "type": "object",
            "description": "Informazioni di paginazione (presente solo se è stato specificato il parametro 'page')",
            "required": ["currentPage", "totalPages"],
            "properties": {
              "currentPage": {
                "type": "integer",
                "description": "Numero della pagina corrente",
                "example": 1
              },
              "totalPages": {
                "type": "integer",
                "description": "Numero totale di pagine disponibili",
                "example": 15
              }
            }
          }
        }
      },
      "Medico": {
        "type": "object",
        "description": "Informazioni su un medico",
        "required": ["nome", "cognome", "asl", "assegnabilita", "tipo"],
        "properties": {
          "nome": {
            "type": "string",
            "description": "Nome del medico",
            "example": "MARIO"
          },
          "cognome": {
            "type": "string",
            "description": "Cognome del medico",
            "example": "ROSSI"
          },
          "asl": {
            "type": "string",
            "description": "ASL di appartenenza (descrizione)",
            "example": "Roma 1"
          },
          "assegnabilita": {
            "type": "string",
            "description": "Stato di assegnabilità",
            "enum": ["Assegnazione libera", "Con deroga", "Non assegnabile"],
            "example": "Assegnazione libera"
          },
          "tipo": {
            "type": "string",
            "description": "Tipo di medico",
            "enum": ["Medicina generale", "Pediatra"],
            "example": "Medicina generale"
          },
          "codiceFiscale": {
            "type": "string",
            "description": "Codice fiscale del medico",
            "example": "RSSMRA80A01H501Z",
            "nullable": true
          },
          "identificativo": {
            "type": "string",
            "description": "Identificativo univoco del medico nel sistema ASL",
            "example": "12345",
            "nullable": true
          },
          "email": {
            "type": "string",
            "format": "email",
            "description": "Email del medico",
            "example": "mario.rossi@example.com",
            "nullable": true
          },
          "indirizzo": {
            "type": "string",
            "description": "Indirizzo dello studio",
            "example": "Via Roma 1",
            "nullable": true
          },
          "luogo": {
            "type": "string",
            "description": "Località dello studio",
            "example": "Roma",
            "nullable": true
          },
          "luogoNascita": {
            "type": "string",
            "description": "Luogo di nascita",
            "example": "Roma",
            "nullable": true
          },
          "codiceDistretto": {
            "type": "string",
            "description": "Codice del distretto sanitario",
            "example": "001",
            "nullable": true
          },
          "descrizioneDistretto": {
            "type": "string",
            "description": "Descrizione del distretto sanitario",
            "example": "Distretto 1",
            "nullable": true
          }
        }
      },
      "ValidationError": {
        "type": "object",
        "required": ["success", "error", "timestamp"],
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Sempre false per errori",
            "example": false
          },
          "error": {
            "type": "string",
            "description": "Messaggio di errore generale",
            "example": "Validazione fallita: parametri non validi."
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp ISO 8601 della risposta",
            "example": "2025-01-11T12:00:00.000Z"
          },
          "validationErrors": {
            "type": "array",
            "description": "Array di errori di validazione specifici",
            "items": {
              "type": "object",
              "required": ["field", "message"],
              "properties": {
                "field": {
                  "type": "string",
                  "description": "Nome del campo che ha fallito la validazione",
                  "example": "cap"
                },
                "value": {
                  "description": "Valore fornito (può essere di qualsiasi tipo)",
                  "example": "123"
                },
                "message": {
                  "type": "string",
                  "description": "Messaggio di errore specifico",
                  "example": "CAP deve essere di 5 cifre."
                }
              }
            }
          }
        }
      },
      "Error": {
        "type": "object",
        "required": ["success", "error", "timestamp"],
        "properties": {
          "success": {
            "type": "boolean",
            "description": "Sempre false per errori",
            "example": false
          },
          "error": {
            "type": "string",
            "description": "Messaggio di errore",
            "example": "Errore interno del server."
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp ISO 8601 della risposta",
            "example": "2025-01-11T12:00:00.000Z"
          }
        }
      }
    }
  }
}
