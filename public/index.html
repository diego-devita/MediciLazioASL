<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Ricerca Medici ASL Lazio</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      overflow-x: auto;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 15px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1rem;
    }

    .header-links {
      display: flex;
      gap: 15px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .bot-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 15px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background 0.3s, transform 0.2s;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .bot-link:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .bot-link svg {
      width: 18px;
      height: 18px;
    }

    .content {
      padding: 30px;
      overflow: visible;
      width: 100%;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }

    input[type="text"],
    input[type="password"],
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }

    .help-text {
      font-size: 0.875rem;
      color: #777;
      margin-top: 5px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      background: #f9f9f9;
    }

    .tab-button {
      flex: 1;
      padding: 18px 20px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
      border: none;
      border-bottom: 3px solid transparent;
      border-radius: 0;
      font-size: 1rem;
      background: transparent;
    }

    .tab-button:hover {
      background: rgba(102, 126, 234, 0.05);
      color: #667eea;
    }

    .tab-button.active {
      color: #667eea;
      background: white;
      border-bottom-color: #667eea;
    }

    .tab-button.active:hover {
      background: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #667eea;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .loading-timer {
      font-size: 0.9rem;
      color: #999;
      margin-top: 5px;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .search-time {
      text-align: center;
      color: #667eea;
      font-size: 0.9rem;
      margin-bottom: 15px;
      font-weight: 500;
    }

    .search-mode-toggle {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
    }

    .toggle-options {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .toggle-option {
      flex: 1;
      position: relative;
    }

    .toggle-option input[type="radio"] {
      display: none;
    }

    .toggle-option label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      font-weight: 500;
      background: white;
      font-size: 1rem;
    }

    .toggle-option input[type="radio"]:checked + label {
      background: #667eea;
      color: white;
      border-color: #667eea;
      font-weight: 600;
    }

    .toggle-option label:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }

    .search-mode-toggle button[type="submit"] {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .search-mode-toggle button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .submit-base {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 20px;
    }

    .submit-base:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .toggle-hint {
      font-size: 0.85rem;
      color: #777;
      margin-top: 8px;
    }

    .batch-progress {
      background: white;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .batch-progress h3 {
      margin: 0 0 15px 0;
      color: #667eea;
      font-size: 1.1rem;
    }

    .progress-bar-container {
      width: 100%;
      height: 35px;
      background: #e0e0e0;
      border-radius: 17px;
      overflow: hidden;
      margin: 15px 0;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.95rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .progress-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
      text-align: left;
    }

    .progress-stat {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .progress-stat strong {
      color: #667eea;
    }

    .cancel-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .cancel-btn:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
    }

    .batch-info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin-top: 15px;
      border-radius: 4px;
    }

    .batch-info h4 {
      margin: 0 0 10px 0;
      color: #1976d2;
      font-size: 1rem;
    }

    .batch-info ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .batch-info li {
      padding: 5px 0;
      font-size: 0.9rem;
      color: #555;
    }

    .warning-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 12px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #856404;
    }

    .error {
      background: #fee;
      border-left: 4px solid #c33;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      color: #c33;
    }

    .success {
      background: #efe;
      border-left: 4px solid #3c3;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      color: #2a2;
    }

    .results {
      margin-top: 30px;
    }

    .results-summary {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-around;
      text-align: center;
    }

    .summary-item {
      flex: 1;
    }

    .summary-number {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
    }

    .summary-label {
      font-size: 0.875rem;
      color: #777;
    }

    .results-table {
      width: 100%;
      min-width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: visible;
      table-layout: fixed;
    }

    #mediciList {
      overflow: visible;
      width: 100%;
    }

    .results {
      overflow: visible;
      width: 100%;
    }

    .results-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .results-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      user-select: none;
      position: relative;
      white-space: nowrap;
    }

    .results-table th:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .results-table th::after {
      content: ' ‚Üï';
      opacity: 0.3;
      font-size: 0.8rem;
      vertical-align: top;
    }

    .results-table th.sort-asc::after {
      content: ' ‚Üë';
      opacity: 1;
    }

    .results-table th.sort-desc::after {
      content: ' ‚Üì';
      opacity: 1;
    }

    /* Larghezze colonne - somma width = 840px (container 900px - 60px padding) */
    .results-table th:nth-child(1),
    .results-table td:nth-child(1) {
      width: 60px;
    }

    .results-table th:nth-child(2),
    .results-table td:nth-child(2) {
      width: 250px;
    }

    .results-table th:nth-child(3),
    .results-table td:nth-child(3) {
      width: 180px;
    }

    .results-table th:nth-child(4),
    .results-table td:nth-child(4) {
      width: 100px;
    }

    .results-table th:nth-child(5),
    .results-table td:nth-child(5) {
      width: 250px;
    }

    .results-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 0.9rem;
    }

    .results-table tbody tr td:nth-child(5) {
      font-size: 0.75em;
    }

    .results-table tbody tr:hover {
      background: #f9f9f9;
    }

    .results-table tbody tr:last-child td {
      border-bottom: none;
    }

    .emoji-cell {
      font-size: 1.2rem;
      text-align: center;
      width: 50px;
    }

    .nome-cell {
      font-weight: 600;
      color: #333;
    }

    .results-table tbody tr {
      position: relative;
      cursor: pointer;
    }

    .tooltip {
      display: none;
      position: absolute;
      z-index: 1000;
      background: white;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      min-width: 300px;
      left: 50%;
      top: 100%;
      transform: translateX(-50%);
      margin-top: 5px;
    }

    .results-table tbody tr:hover .tooltip {
      display: block;
    }

    .tooltip-title {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1rem;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 5px;
    }

    .tooltip-row {
      display: flex;
      padding: 5px 0;
      font-size: 0.875rem;
    }

    .tooltip-label {
      font-weight: 600;
      color: #555;
      min-width: 140px;
    }

    .tooltip-value {
      color: #333;
    }

    .legend {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .legend-title {
      font-weight: 600;
      margin-bottom: 10px;
    }

    .legend-item {
      display: inline-block;
      margin-right: 20px;
      font-size: 0.875rem;
    }

    .footer {
      text-align: center;
      padding: 20px;
      color: #777;
      font-size: 0.875rem;
      border-top: 1px solid #e0e0e0;
    }

    /* Multi-select Dropdown per ASL */
    .multiselect-container {
      position: relative;
      width: 100%;
    }

    .multiselect-header {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: border-color 0.3s;
      font-size: 1rem;
    }

    .multiselect-header:hover {
      border-color: #667eea;
    }

    .multiselect-header.open {
      border-color: #667eea;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }

    .multiselect-header-text {
      flex: 1;
      color: #999;
    }

    .multiselect-header-text.has-selection {
      color: #333;
    }

    .multiselect-header-arrow {
      color: #666;
      transition: transform 0.3s;
      font-size: 0.8rem;
    }

    .multiselect-header-arrow.open {
      transform: rotate(180deg);
    }

    .multiselect-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #667eea;
      border-top: none;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
    }

    .multiselect-dropdown.open {
      display: block;
    }

    .multiselect-option {
      padding: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
      border-bottom: 1px solid #f0f0f0;
    }

    .multiselect-option:last-child {
      border-bottom: none;
    }

    .multiselect-option:hover {
      background: #f5f5f5;
    }

    .multiselect-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      margin: 0;
    }

    .multiselect-option label {
      cursor: pointer;
      margin: 0;
      flex: 1;
      font-weight: normal;
    }

    /* Mobile Sort Control (nascosto su desktop) */
    .mobile-sort-control {
      display: none;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      gap: 10px;
      align-items: center;
    }

    .mobile-sort-label {
      font-weight: 600;
      color: #555;
      white-space: nowrap;
    }

    .mobile-sort-select {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
    }

    .mobile-sort-toggle {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
    }

    .mobile-sort-toggle:active {
      background: #5568d3;
    }

    /* Card Layout (nascosto su desktop) */
    .results-cards {
      display: none;
    }

    .result-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      position: relative;
    }

    .result-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .card-emoji {
      font-size: 1.5rem;
    }

    .card-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      flex: 1;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #f0f0f0;
    }

    .card-stato {
      font-size: 0.85rem;
      color: #666;
    }

    .card-asl {
      font-size: 0.85rem;
      color: #555;
      font-weight: 600;
    }

    /* Media Query per Mobile */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 20px 15px;
      }

      .header h1 {
        font-size: 1.5rem;
      }

      .header-links {
        flex-direction: column;
        gap: 10px;
      }

      .bot-link {
        width: 100%;
        justify-content: center;
      }

      .content {
        padding: 20px 15px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      /* Nascondi tabella su mobile, mostra card */
      .results-table {
        display: none !important;
      }

      .results-cards {
        display: block;
      }

      .mobile-sort-control {
        display: flex;
      }

      /* Toggle pi√π compatto */
      .toggle-options {
        gap: 10px;
      }

      .toggle-option label {
        font-size: 0.9rem;
        padding: 10px;
        gap: 6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü©∫ Ricerca Medici ASL Lazio</h1>
      <div class="header-links">
        <a href="/admin" class="bot-link" id="adminLink" style="display: none;">
          <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 18px; height: 18px;">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 2.182c5.423 0 9.818 4.395 9.818 9.818 0 5.423-4.395 9.818-9.818 9.818-5.423 0-9.818-4.395-9.818-9.818 0-5.423 4.395-9.818 9.818-9.818zM12 6c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3zm0 8c-2.667 0-8 1.333-8 4v2h16v-2c0-2.667-5.333-4-8-4z" fill="white"/>
          </svg>
          Admin Panel
        </a>
        <a href="/bot" class="bot-link">
          <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z" fill="white"/>
          </svg>
          Ricevi notifiche con Telegram Bot
        </a>
        <a href="/swagger" class="bot-link" target="_blank" rel="noopener noreferrer">
          <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 0C5.383 0 0 5.383 0 12s5.383 12 12 12c6.616 0 12-5.383 12-12S18.616 0 12 0zm0 1.144c5.995 0 10.856 4.86 10.856 10.856 0 5.995-4.86 10.856-10.856 10.856-5.996 0-10.856-4.86-10.856-10.856C1.144 6.004 6.004 1.144 12 1.144zM8.37 5.868a6.707 6.707 0 0 0-.423.005c-.983.056-1.573.517-1.735 1.472-.115.665-.096 1.348-.143 2.017-.013.35-.05.697-.115 1.038-.134.609-.397.798-1.016.83a2.65 2.65 0 0 0-.244.042v1.463c1.126.055 1.278.452 1.37 1.629.033.429-.013.858.015 1.287.018.406.073.808.156 1.2.259 1.075 1.307 1.435 2.575 1.218v-1.283c-.203 0-.383.005-.558-.014-.43-.037-.609-.366-.609-1.343 0-.388-.009-.775-.019-1.163-.013-.471-.038-.937-.189-1.385-.212-.549-.677-.77-1.253-.888.586-.12 1.041-.34 1.253-.888.151-.448.176-.914.189-1.385.01-.388.019-.775.019-1.163 0-.977.179-1.306.609-1.343a5.822 5.822 0 0 1 .558-.014V5.868h-.005zm7.26 0v1.283c.203 0 .383-.005.558.014.43.037.609.366.609 1.343 0 .388.009.775.019 1.163.013.471.038.937.189 1.385.212.549.676.77 1.253.888-.587.12-1.041.34-1.253.888-.151.448-.176.914-.189 1.385-.01.388-.019.775-.019 1.163 0 .977-.179 1.306-.609 1.343a5.822 5.822 0 0 1-.558.014v1.283c1.268.217 2.316-.143 2.575-1.218.083-.392.138-.794.156-1.2.028-.429-.018-.858.015-1.287.092-1.177.244-1.574 1.37-1.629v-1.463a2.65 2.65 0 0 0-.244-.042c-.619-.032-.882-.221-1.016-.83-.065-.341-.102-.688-.115-1.038-.047-.669-.028-1.352-.143-2.017-.162-.955-.752-1.416-1.735-1.472a6.707 6.707 0 0 0-.423-.005h-.005z" fill="white"/>
          </svg>
          Documentazione API
          <svg style="width: 14px; height: 14px; margin-left: 4px; vertical-align: middle; opacity: 0.8;" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3m-2 16H5V5h7V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-2v7z" fill="white"/>
          </svg>
        </a>
      </div>
    </div>

    <div class="tabs">
      <button type="button" class="tab-button active" data-tab="base">Base</button>
      <button type="button" class="tab-button" data-tab="avanzate">Avanzate</button>
    </div>

    <div class="content">
      <form id="searchForm">
        <div id="tab-base" class="tab-content active">
          <div class="form-group">
            <label for="asl-base">ASL</label>
            <div class="multiselect-container" id="aslMultiselectBase">
              <div class="multiselect-header" id="aslHeaderBase">
                <span class="multiselect-header-text" id="aslHeaderTextBase">Tutte</span>
                <span class="multiselect-header-arrow" id="aslHeaderArrowBase">‚ñº</span>
              </div>
              <div class="multiselect-dropdown" id="aslDropdownBase">
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_base_roma1" value="120201">
                  <label for="asl_base_roma1">Roma 1</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_base_roma2" value="120202">
                  <label for="asl_base_roma2">Roma 2</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_base_roma3" value="120203">
                  <label for="asl_base_roma3">Roma 3</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_base_roma4" value="120204">
                  <label for="asl_base_roma4">Roma 4</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_base_roma5" value="120205">
                  <label for="asl_base_roma5">Roma 5</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_base_roma6" value="120206">
                  <label for="asl_base_roma6">Roma 6</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_base_frosinone" value="120207">
                  <label for="asl_base_frosinone">Frosinone</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_base_latina" value="120208">
                  <label for="asl_base_latina">Latina</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_base_rieti" value="120209">
                  <label for="asl_base_rieti">Rieti</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_base_viterbo" value="120210">
                  <label for="asl_base_viterbo">Viterbo</label>
                </div>
              </div>
            </div>
            <p class="help-text">Seleziona una o pi√π ASL dalla lista</p>
          </div>

          <div class="form-group">
            <label for="cognomi-base">Cognomi</label>
            <input type="text" id="cognomi-base" name="cognomi-base" placeholder="es. ROSSI, BIANCHI, VERDI, MAGO'">
            <p class="help-text">Inserisci uno o pi√π cognomi separati da virgola</p>
          </div>
        </div>

        <div id="tab-avanzate" class="tab-content">
          <div class="form-group">
            <label for="asl">ASL</label>
            <div class="multiselect-container" id="aslMultiselect">
              <div class="multiselect-header" id="aslHeader">
                <span class="multiselect-header-text" id="aslHeaderText">Tutte</span>
                <span class="multiselect-header-arrow" id="aslHeaderArrow">‚ñº</span>
              </div>
              <div class="multiselect-dropdown" id="aslDropdown">
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_roma1" value="120201">
                  <label for="asl_roma1">Roma 1</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_roma2" value="120202">
                  <label for="asl_roma2">Roma 2</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_roma3" value="120203">
                  <label for="asl_roma3">Roma 3</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_roma4" value="120204">
                  <label for="asl_roma4">Roma 4</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_roma5" value="120205">
                  <label for="asl_roma5">Roma 5</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_roma6" value="120206">
                  <label for="asl_roma6">Roma 6</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_frosinone" value="120207">
                  <label for="asl_frosinone">Frosinone</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_latina" value="120208">
                  <label for="asl_latina">Latina</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_rieti" value="120209">
                  <label for="asl_rieti">Rieti</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="asl_viterbo" value="120210">
                  <label for="asl_viterbo">Viterbo</label>
                </div>
              </div>
            </div>
            <p class="help-text">Seleziona una o pi√π ASL dalla lista</p>
          </div>

          <div class="form-group">
            <label for="cap">CAP</label>
            <input type="text" id="cap" name="cap" placeholder="es. 00100, 00118, 00185">
            <p class="help-text">Inserisci uno o pi√π CAP separati da virgola</p>
          </div>

          <div class="form-group">
            <label for="cognomi">Cognomi</label>
            <input type="text" id="cognomi" name="cognomi" placeholder="es. ROSSI, BIANCHI, VERDI, MAGO'">
            <p class="help-text">Inserisci uno o pi√π cognomi separati da virgola</p>
          </div>

          <div class="form-group">
            <label for="nomi">Nomi</label>
            <input type="text" id="nomi" name="nomi" placeholder="es. MARIO, LUIGI, PAOLO">
            <p class="help-text">Inserisci uno o pi√π nomi separati da virgola</p>
          </div>

          <!-- Search Mode Toggle + Submit Button (solo in Avanzate) -->
          <div class="search-mode-toggle">
            <div class="toggle-options">
              <div class="toggle-option">
                <input type="radio" id="mode-standard" name="searchMode" value="standard" checked>
                <label for="mode-standard">üöÄ Singola</label>
              </div>
              <div class="toggle-option">
                <input type="radio" id="mode-batch" name="searchMode" value="batch">
                <label for="mode-batch">üîÑ Batch</label>
              </div>
            </div>
            <div id="warningBox" class="warning-box" style="display: none;"></div>
            <button type="submit" id="submitBtn">üîç Cerca</button>
          </div>
        </div>

        <!-- Submit button per Base (fuori dal tab) -->
        <button type="submit" id="submitBtnBase" class="submit-base">üîç Cerca</button>
      </form>

      <div id="loading" style="display: none;" class="loading">
        Ricerca in corso
        <div class="loading-timer" id="loadingTimer">0.0s</div>
        <button type="button" id="cancelBtnStandard" class="cancel-btn">‚ùå Annulla ricerca</button>
      </div>

      <!-- Batch Progress Bar -->
      <div id="batchProgress" style="display: none;" class="batch-progress">
        <h3>üîÑ Ricerca batch in corso...</h3>
        <div class="progress-bar-container">
          <div id="progressBarFill" class="progress-bar-fill" style="width: 0%;">0%</div>
        </div>
        <div class="progress-stats">
          <div class="progress-stat">
            <span>üìä Progresso:</span>
            <strong id="progressQueries">0/0 query</strong>
          </div>
          <div class="progress-stat">
            <span>‚è±Ô∏è Tempo:</span>
            <strong id="progressTime">0.0s</strong>
          </div>
          <div class="progress-stat">
            <span>‚úÖ Risultati:</span>
            <strong id="progressResults">0 medici</strong>
          </div>
          <div class="progress-stat">
            <span>‚ö†Ô∏è Errori:</span>
            <strong id="progressErrors">0</strong>
          </div>
        </div>
        <button type="button" id="cancelBtn" class="cancel-btn">‚ùå Annulla ricerca</button>
      </div>

      <div id="error" style="display: none;" class="error"></div>

      <div id="results" style="display: none;" class="results">
        <div class="search-time" id="searchTime"></div>
        <div class="results-summary">
          <div class="summary-item">
            <div class="summary-number" id="totalCount">0</div>
            <div class="summary-label">Totali</div>
          </div>
          <div class="summary-item">
            <div class="summary-number" style="color: #22c55e;" id="liberiCount">0</div>
            <div class="summary-label">Assegnabili liberamente</div>
          </div>
          <div class="summary-item">
            <div class="summary-number" style="color: #f59e0b;" id="derogaCount">0</div>
            <div class="summary-label">Con deroga</div>
          </div>
          <div class="summary-item">
            <div class="summary-number" style="color: #ef4444;" id="altroCount">0</div>
            <div class="summary-label">Altro</div>
          </div>
        </div>

        <!-- Batch Info Box (solo per ricerche batch) -->
        <div id="batchInfo" style="display: none;" class="batch-info">
          <h4>‚ÑπÔ∏è Dettagli ricerca batch</h4>
          <ul id="batchInfoList"></ul>
        </div>

        <!-- Mobile Sort Control (visibile solo su mobile) -->
        <div class="mobile-sort-control">
          <span class="mobile-sort-label">Ordina per:</span>
          <select id="mobileSortSelect" class="mobile-sort-select">
            <option value="cognome">Cognome</option>
            <option value="nome">Nome</option>
            <option value="asl">ASL</option>
            <option value="assegnabilita">Stato</option>
          </select>
          <button id="mobileSortToggle" class="mobile-sort-toggle">‚Üë ASC</button>
        </div>

        <div id="mediciList"></div>

        <div class="legend">
          <div class="legend-title">Legenda:</div>
          <span class="legend-item">üü¢ Assegnazione libera</span>
          <span class="legend-item">üü† Assegnabile con deroga</span>
          <span class="legend-item">üî¥ Non assegnabile</span>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>MediciLazioASL - Sistema di ricerca medici disponibili</p>
      <p>Dati aggiornati dal portale Salute Lazio</p>
    </div>
  </div>

  <!-- Auth check -->
  <script src="/auth-check.js"></script>

  <script type="module">
    import { BatchSearchClient } from '/batch-search-client.js';

    const form = document.getElementById('searchForm');
    const loading = document.getElementById('loading');
    const batchProgress = document.getElementById('batchProgress');
    const error = document.getElementById('error');
    const results = document.getElementById('results');
    const submitBtn = document.getElementById('submitBtn');
    const loadingTimer = document.getElementById('loadingTimer');
    const searchTime = document.getElementById('searchTime');
    const warningBox = document.getElementById('warningBox');
    const batchInfo = document.getElementById('batchInfo');
    const cancelBtn = document.getElementById('cancelBtn');
    const cancelBtnStandard = document.getElementById('cancelBtnStandard');

    let currentData = null;
    let sortColumn = null;
    let sortDirection = 'asc';
    let timerInterval = null;
    let startTime = null;
    let batchClient = null;
    let standardAbortController = null;

    // Check if user is admin and show admin link
    (async function checkIfAdmin() {
      try {
        const response = await fetch('/api/user/me', {
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.user && data.user.role === 'admin') {
            document.getElementById('adminLink').style.display = 'inline-flex';
          }
        }
      } catch (err) {
        // Silently fail - admin link stays hidden
      }
    })();

    // Gestione tab
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTab = button.dataset.tab;

        // Rimuovi active da tutti i button e content
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        // Aggiungi active al button cliccato e al suo content
        button.classList.add('active');
        document.getElementById(`tab-${targetTab}`).classList.add('active');

        // Reset solo errori e risultati, NON i campi (che sono sincronizzati)
        hideError();
        results.style.display = 'none';

        // Gestisci visibilit√† bottoni submit
        const submitBtnBase = document.getElementById('submitBtnBase');
        const submitBtnAvanzate = document.getElementById('submitBtn');

        if (targetTab === 'base') {
          submitBtnBase.style.display = 'block';
          // In modalit√† Base, forza Standard mode
          document.getElementById('mode-standard').checked = true;
        } else {
          submitBtnBase.style.display = 'none';
        }

        // Ricalcola warning
        checkCombinationsWarning();
      });
    });

    function getStatoEmoji(assegnabilita) {
      const stato = assegnabilita.toLowerCase();
      if (stato.includes('assegnazione libera')) return 'üü¢';
      if (stato.includes('deroga')) return 'üü†';
      if (stato.includes('non assegnabile')) return 'üî¥';
      return '‚ö™';
    }

    function showError(message) {
      error.textContent = message;
      error.style.display = 'block';
      results.style.display = 'none';
    }

    function hideError() {
      error.style.display = 'none';
    }

    function showLoading() {
      loading.style.display = 'block';
      submitBtn.disabled = true;
      hideError();
      results.style.display = 'none';

      // Avvia il timer
      startTime = Date.now();
      loadingTimer.textContent = '0.0s';

      timerInterval = setInterval(() => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        loadingTimer.textContent = `${elapsed}s`;
      }, 100);
    }

    function hideLoading() {
      loading.style.display = 'none';
      submitBtn.disabled = false;

      // Ferma il timer
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      // Calcola il tempo totale
      if (startTime) {
        const totalTime = ((Date.now() - startTime) / 1000).toFixed(2);
        searchTime.textContent = `‚è±Ô∏è Ricerca completata in ${totalTime}s`;
      }
    }

    function showBatchProgress() {
      batchProgress.style.display = 'block';
      submitBtn.disabled = true;
      hideError();
      results.style.display = 'none';
    }

    function hideBatchProgress() {
      batchProgress.style.display = 'none';
      submitBtn.disabled = false;
    }

    function updateBatchProgress(progress) {
      document.getElementById('progressBarFill').style.width = `${progress.percentage}%`;
      document.getElementById('progressBarFill').textContent = `${progress.percentage}%`;
      document.getElementById('progressQueries').textContent = `${progress.completed}/${progress.total} query`;
      document.getElementById('progressTime').textContent = `${(progress.duration / 1000).toFixed(1)}s`;
      document.getElementById('progressResults').textContent = `${progress.results} medici`;
      document.getElementById('progressErrors').textContent = progress.errors;
    }

    function displayBatchInfo(meta) {
      if (!meta) {
        batchInfo.style.display = 'none';
        return;
      }

      const list = document.getElementById('batchInfoList');
      const duplicatesRemoved = meta.deduplicatedFrom - meta.deduplicatedTo;
      const successRate = ((meta.totalQueries - meta.errors) / meta.totalQueries * 100).toFixed(1);

      list.innerHTML = `
        <li>‚Ä¢ ${meta.totalQueries} query eseguite in ${(meta.duration / 1000).toFixed(1)}s</li>
        <li>‚Ä¢ ${meta.deduplicatedFrom} risultati totali ‚Üí ${meta.deduplicatedTo} dopo deduplicazione</li>
        <li>‚Ä¢ ${duplicatesRemoved} duplicati rimossi</li>
        <li>‚Ä¢ ${meta.errors} query fallite (${successRate}% successo)</li>
      `;

      batchInfo.style.display = 'block';
      searchTime.textContent = `‚è±Ô∏è Ricerca batch completata in ${(meta.duration / 1000).toFixed(2)}s`;
    }

    function checkCombinationsWarning() {
      const activeTab = document.querySelector('.tab-button.active').dataset.tab;
      const searchModeElement = document.querySelector('input[name="searchMode"]:checked');
      const searchMode = searchModeElement ? searchModeElement.value : 'standard';

      let cognomiCount, capCount, nomiCount;

      if (activeTab === 'base') {
        const cognomiBase = document.getElementById('cognomi-base').value.trim();
        cognomiCount = cognomiBase ? cognomiBase.split(',').filter(c => c.trim()).length : 0;
        capCount = 0;
        nomiCount = 0;
      } else {
        const cognomi = document.getElementById('cognomi').value.trim();
        const cap = document.getElementById('cap').value.trim();
        const nomi = document.getElementById('nomi').value.trim();

        cognomiCount = cognomi ? cognomi.split(',').filter(c => c.trim()).length : 0;
        capCount = cap ? cap.split(',').filter(c => c.trim()).length : 0;
        nomiCount = nomi ? nomi.split(',').filter(n => n.trim()).length : 0;
      }

      // Calcola combinazioni (almeno 1 per ogni dimensione)
      const combinations = Math.max(1, cognomiCount) * Math.max(1, capCount) * Math.max(1, nomiCount);

      if (combinations > 10 && searchMode === 'standard') {
        warningBox.innerHTML = `‚ö†Ô∏è Con <strong>${combinations} combinazioni</strong> potrebbe esserci timeout. Consigliamo <strong>modalit√† Batch</strong>.`;
        warningBox.style.display = 'block';
      } else {
        warningBox.style.display = 'none';
      }
    }

    // Event listener per il warning
    const cognomiFields = [
      document.getElementById('cognomi-base'),
      document.getElementById('cognomi'),
      document.getElementById('cap'),
      document.getElementById('nomi')
    ];

    cognomiFields.forEach(field => {
      if (field) {
        field.addEventListener('input', checkCombinationsWarning);
      }
    });

    document.querySelectorAll('input[name="searchMode"]').forEach(radio => {
      radio.addEventListener('change', checkCombinationsWarning);
    });

    // Cancel button (batch)
    cancelBtn.addEventListener('click', () => {
      if (batchClient) {
        batchClient.abort();
        hideBatchProgress();
        showError('Ricerca annullata dall\'utente.');
      }
    });

    // Cancel button (standard)
    cancelBtnStandard.addEventListener('click', () => {
      if (standardAbortController) {
        standardAbortController.abort();
        hideLoading();
        showError('Ricerca annullata dall\'utente.');
      }
    });

    function sortData(column) {
      if (!currentData) return;

      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }

      currentData.results.sort((a, b) => {
        let aVal = a[column] || '';
        let bVal = b[column] || '';

        // Conversione a lowercase per stringhe
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();

        if (sortDirection === 'asc') {
          return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
        } else {
          return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
        }
      });

      renderTable(currentData);
    }

    function renderCards(data) {
      const mediciList = document.getElementById('mediciList');

      const cardsContainer = document.createElement('div');
      cardsContainer.className = 'results-cards';

      data.results.forEach(medico => {
        const emoji = getStatoEmoji(medico.assegnabilita);

        const card = document.createElement('div');
        card.className = 'result-card';

        card.innerHTML = `
          <div class="card-header">
            <div class="card-emoji">${emoji}</div>
            <div class="card-name">${medico.cognome} ${medico.nome}</div>
          </div>
          <div class="card-footer">
            <div class="card-stato">${medico.assegnabilita}</div>
            <div class="card-asl">${medico.asl}</div>
          </div>
        `;

        cardsContainer.appendChild(card);
      });

      mediciList.appendChild(cardsContainer);
    }

    function renderTable(data) {
      const mediciList = document.getElementById('mediciList');
      mediciList.innerHTML = '';

      // Render tabella desktop
      const table = document.createElement('table');
      table.className = 'results-table';

      const columns = [
        { key: 'assegnabilita', label: '', isEmoji: true },
        { key: 'cognome', label: 'Cognome' },
        { key: 'nome', label: 'Nome' },
        { key: 'asl', label: 'ASL' },
        { key: 'assegnabilita', label: 'Stato' }
      ];

      table.innerHTML = `
        <thead>
          <tr>
            ${columns.map(col => {
              const sortClass = sortColumn === col.key ? `sort-${sortDirection}` : '';
              return `<th class="${sortClass}" data-column="${col.key}">${col.label}</th>`;
            }).join('')}
          </tr>
        </thead>
        <tbody>
            ${data.results.map(medico => {
              const emoji = getStatoEmoji(medico.assegnabilita);

              // Costruisci tooltip con tutti i dati disponibili
              let tooltipContent = `
                <div class="tooltip-title">Dettagli completi</div>
                ${medico.codiceFiscale ? `<div class="tooltip-row"><span class="tooltip-label">Codice Fiscale:</span><span class="tooltip-value">${medico.codiceFiscale}</span></div>` : ''}
                ${medico.email ? `<div class="tooltip-row"><span class="tooltip-label">Email:</span><span class="tooltip-value">${medico.email}</span></div>` : ''}
                ${medico.indirizzo ? `<div class="tooltip-row"><span class="tooltip-label">Indirizzo:</span><span class="tooltip-value">${medico.indirizzo}</span></div>` : ''}
                ${medico.luogo ? `<div class="tooltip-row"><span class="tooltip-label">Luogo:</span><span class="tooltip-value">${medico.luogo}</span></div>` : ''}
                ${medico.luogoNascita ? `<div class="tooltip-row"><span class="tooltip-label">Luogo Nascita:</span><span class="tooltip-value">${medico.luogoNascita}</span></div>` : ''}
                ${medico.identificativo ? `<div class="tooltip-row"><span class="tooltip-label">Identificativo:</span><span class="tooltip-value">${medico.identificativo}</span></div>` : ''}
                ${medico.codiceDistretto ? `<div class="tooltip-row"><span class="tooltip-label">Codice Distretto:</span><span class="tooltip-value">${medico.codiceDistretto}</span></div>` : ''}
                ${medico.descrizioneDistretto ? `<div class="tooltip-row"><span class="tooltip-label">Distretto:</span><span class="tooltip-value">${medico.descrizioneDistretto}</span></div>` : ''}
              `;

              return `
                <tr>
                  <td class="emoji-cell">${emoji}</td>
                  <td class="nome-cell">${medico.cognome}</td>
                  <td>${medico.nome}</td>
                  <td>${medico.asl}</td>
                  <td>${medico.assegnabilita}</td>
                  <td style="position: relative;">
                    <div class="tooltip">${tooltipContent}</div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        `;

      mediciList.appendChild(table);

      // Aggiungi event listener per il sorting (desktop)
      table.querySelectorAll('th[data-column]').forEach(th => {
        th.addEventListener('click', () => {
          sortData(th.dataset.column);
        });
      });

      // Render cards mobile
      renderCards(data);
    }

    function displayResults(data) {
      currentData = data;
      sortColumn = null;
      sortDirection = 'asc';

      // Calcola i contatori per categoria
      // Usa i contatori dall'API
      document.getElementById('totalCount').textContent = data.counters.totali;
      document.getElementById('liberiCount').textContent = data.counters.assegnabili;
      document.getElementById('derogaCount').textContent = data.counters.conDeroga;
      document.getElementById('altroCount').textContent = data.counters.nonAssegnabili;

      if (data.results.length === 0) {
        document.getElementById('mediciList').innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">Nessun medico trovato con i criteri specificati.</p>';
      } else {
        renderTable(data);
      }

      results.style.display = 'block';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Determina quale tab √® attivo
      const activeTab = document.querySelector('.tab-button.active').dataset.tab;
      // In modalit√† Base, forza sempre Standard
      const searchMode = activeTab === 'base' ? 'standard' : document.querySelector('input[name="searchMode"]:checked').value;

      let cognomi, cap, nomi;
      let selectedAsl, aslToSend;

      // Tipo medico fisso a "Medicina generale"
      const tipo = 'Medicina generale';

      if (activeTab === 'base') {
        // Tab Base: usa ASL Base
        selectedAsl = getSelectedAslBase();
        aslToSend = selectedAsl;
        const hasAsl = selectedAsl.length > 0;

        // Cognomi da tab base
        cognomi = document.getElementById('cognomi-base').value
          .split(',')
          .map(c => c.trim().toUpperCase())
          .filter(c => c.length > 0);

        cap = [];
        nomi = [];

        if (cognomi.length === 0 && !hasAsl) {
          showError('Inserisci almeno uno tra: Cognomi, ASL');
          return;
        }

        // Ottimizzazione: se tutte ASL selezionate + cognomi compilati, usa ASL vuoto
        if (selectedAsl.length === ALL_ASL_OPTIONS.length && cognomi.length > 0) {
          aslToSend = [];
        }
      } else {
        // Tab Avanzate: usa ASL Avanzate
        selectedAsl = getSelectedAsl();
        aslToSend = selectedAsl;
        const hasAsl = selectedAsl.length > 0;

        // Campi da tab avanzate
        cognomi = document.getElementById('cognomi').value
          .split(',')
          .map(c => c.trim().toUpperCase())
          .filter(c => c.length > 0);

        cap = document.getElementById('cap').value
          .split(',')
          .map(c => c.trim())
          .filter(c => c.length > 0);

        nomi = document.getElementById('nomi').value
          .split(',')
          .map(n => n.trim().toUpperCase())
          .filter(n => n.length > 0);

        if (cognomi.length === 0 && cap.length === 0 && nomi.length === 0 && !hasAsl) {
          showError('Inserisci almeno uno tra: CAP, Cognomi, Nomi, ASL');
          return;
        }

        // Ottimizzazione: se tutte ASL selezionate + almeno un altro campo, usa ASL vuoto
        const hasOtherFields = cognomi.length > 0 || cap.length > 0 || nomi.length > 0;
        if (selectedAsl.length === ALL_ASL_OPTIONS.length && hasOtherFields) {
          aslToSend = [];
        }
      }

      // MODALIT√Ä BATCH
      if (searchMode === 'batch') {
        showBatchProgress();

        try {
          batchClient = new BatchSearchClient({
            parallelism: 5,
            onProgress: (progress) => {
              updateBatchProgress(progress);
            }
          });

          const result = await batchClient.search({
            cognomi,
            cap,
            nomi,
            tipo,
            asl: aslToSend
          });

          hideBatchProgress();

          if (!result.success) {
            showError(result.error || 'Errore durante la ricerca batch.');
            return;
          }

          // Mostra batch info
          if (result.meta) {
            displayBatchInfo(result.meta);
          }

          displayResults(result);
        } catch (err) {
          hideBatchProgress();
          showError('Errore durante la ricerca batch. Riprova pi√π tardi.');
          console.error('Batch search error:', err);
        }

        return;
      }

      // MODALIT√Ä STANDARD
      showLoading();

      try {
        standardAbortController = new AbortController();

        const response = await fetch('/api/search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          signal: standardAbortController.signal,
          body: JSON.stringify({
            cognomi,
            asl: aslToSend,
            tipo,
            cap,
            nomi
          })
        });

        const data = await response.json();

        hideLoading();

        if (!response.ok) {
          if (response.status === 401) {
            // Non autenticato - redirect a login
            window.location.href = '/login';
            return;
          } else {
            showError(data.error || 'Errore durante la ricerca.');
          }
          return;
        }

        if (!data.success) {
          showError(data.error || 'Errore durante la ricerca.');
          return;
        }

        // Nascondi batch info se standard mode
        batchInfo.style.display = 'none';

        displayResults(data);
      } catch (err) {
        hideLoading();
        if (err.name === 'AbortError') {
          // Ricerca annullata, non mostrare errore (gi√† gestito nel click handler)
          return;
        }
        showError('Errore di connessione. Riprova pi√π tardi.');
        console.error('Search error:', err);
      }
    });

    // ===== MULTI-SELECT ASL DROPDOWN =====
    const ALL_ASL_OPTIONS = ['120201', '120202', '120203', '120204', '120205', '120206', '120207', '120208', '120209', '120210'];

    // Setup multi-select per Base
    const aslHeaderBase = document.getElementById('aslHeaderBase');
    const aslHeaderTextBase = document.getElementById('aslHeaderTextBase');
    const aslHeaderArrowBase = document.getElementById('aslHeaderArrowBase');
    const aslDropdownBase = document.getElementById('aslDropdownBase');
    const aslCheckboxesBase = aslDropdownBase.querySelectorAll('input[type="checkbox"]');

    // Setup multi-select per Avanzate
    const aslHeader = document.getElementById('aslHeader');
    const aslHeaderText = document.getElementById('aslHeaderText');
    const aslHeaderArrow = document.getElementById('aslHeaderArrow');
    const aslDropdown = document.getElementById('aslDropdown');
    const aslCheckboxes = aslDropdown.querySelectorAll('input[type="checkbox"]');

    // Funzioni per Base
    function openAslDropdownBase() {
      aslDropdownBase.classList.add('open');
      aslHeaderBase.classList.add('open');
      aslHeaderArrowBase.classList.add('open');
    }

    function closeAslDropdownBase() {
      aslDropdownBase.classList.remove('open');
      aslHeaderBase.classList.remove('open');
      aslHeaderArrowBase.classList.remove('open');
    }

    function updateAslHeaderTextBase() {
      const selected = getSelectedAslBase();

      if (selected.length === 0) {
        aslHeaderTextBase.textContent = 'Tutte';
        aslHeaderTextBase.classList.remove('has-selection');
      } else if (selected.length === ALL_ASL_OPTIONS.length) {
        aslHeaderTextBase.textContent = 'Tutte';
        aslHeaderTextBase.classList.remove('has-selection');
      } else {
        aslHeaderTextBase.textContent = selected.join(', ');
        aslHeaderTextBase.classList.add('has-selection');
      }
    }

    function getSelectedAslBase() {
      const selected = [];
      aslCheckboxesBase.forEach(cb => {
        if (cb.checked) {
          selected.push(cb.value);
        }
      });
      return selected;
    }

    // Funzioni per Avanzate
    function openAslDropdown() {
      aslDropdown.classList.add('open');
      aslHeader.classList.add('open');
      aslHeaderArrow.classList.add('open');
    }

    function closeAslDropdown() {
      aslDropdown.classList.remove('open');
      aslHeader.classList.remove('open');
      aslHeaderArrow.classList.remove('open');
    }

    function updateAslHeaderText() {
      const selected = getSelectedAsl();

      if (selected.length === 0) {
        aslHeaderText.textContent = 'Tutte';
        aslHeaderText.classList.remove('has-selection');
      } else if (selected.length === ALL_ASL_OPTIONS.length) {
        aslHeaderText.textContent = 'Tutte';
        aslHeaderText.classList.remove('has-selection');
      } else {
        aslHeaderText.textContent = selected.join(', ');
        aslHeaderText.classList.add('has-selection');
      }
    }

    function getSelectedAsl() {
      const selected = [];
      aslCheckboxes.forEach(cb => {
        if (cb.checked) {
          selected.push(cb.value);
        }
      });
      return selected;
    }

    // Event listeners per Base
    aslHeaderBase.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = aslDropdownBase.classList.contains('open');
      if (isOpen) {
        closeAslDropdownBase();
      } else {
        openAslDropdownBase();
      }
    });

    aslCheckboxesBase.forEach(cb => {
      cb.addEventListener('change', () => {
        updateAslHeaderTextBase();
        // Sincronizza con Avanzate
        syncAslFromBaseToAvanzate();
      });
    });

    aslDropdownBase.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Event listeners per Avanzate
    aslHeader.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = aslDropdown.classList.contains('open');
      if (isOpen) {
        closeAslDropdown();
      } else {
        openAslDropdown();
      }
    });

    aslCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        updateAslHeaderText();
        checkCombinationsWarning();
        // Sincronizza con Base
        syncAslFromAvanzateToBase();
      });
    });

    aslDropdown.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!document.getElementById('aslMultiselectBase').contains(e.target)) {
        closeAslDropdownBase();
      }
      if (!document.getElementById('aslMultiselect').contains(e.target)) {
        closeAslDropdown();
      }
    });

    // ===== MOBILE SORT CONTROL =====
    const mobileSortSelect = document.getElementById('mobileSortSelect');
    const mobileSortToggle = document.getElementById('mobileSortToggle');
    let mobileSortDirection = 'asc';

    mobileSortSelect.addEventListener('change', () => {
      if (currentData) {
        sortData(mobileSortSelect.value);
      }
    });

    mobileSortToggle.addEventListener('click', () => {
      mobileSortDirection = mobileSortDirection === 'asc' ? 'desc' : 'asc';
      mobileSortToggle.textContent = mobileSortDirection === 'asc' ? '‚Üë ASC' : '‚Üì DESC';

      if (currentData) {
        sortDirection = mobileSortDirection;
        sortData(sortColumn || mobileSortSelect.value);
      }
    });

    // ===== SINCRONIZZAZIONE CAMPI TRA BASE E AVANZATE =====
    function syncAslFromBaseToAvanzate() {
      aslCheckboxesBase.forEach((cbBase, index) => {
        aslCheckboxes[index].checked = cbBase.checked;
      });
      updateAslHeaderText();
    }

    function syncAslFromAvanzateToBase() {
      aslCheckboxes.forEach((cbAvanzate, index) => {
        aslCheckboxesBase[index].checked = cbAvanzate.checked;
      });
      updateAslHeaderTextBase();
    }

    // Sincronizzazione Cognomi
    const cognomiBase = document.getElementById('cognomi-base');
    const cognomiAvanzate = document.getElementById('cognomi');

    cognomiBase.addEventListener('input', () => {
      cognomiAvanzate.value = cognomiBase.value;
    });

    cognomiAvanzate.addEventListener('input', () => {
      cognomiBase.value = cognomiAvanzate.value;
    });

    // Inizializzazione: nascondi bottone Base all'avvio (parte da tab Base attivo)
    document.getElementById('submitBtnBase').style.display = 'block';
  </script>
</body>
</html>
