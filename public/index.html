<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Ricerca Medici ASL Lazio</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      overflow-x: auto;
    }

    .container {
      max-width: 900px;
      min-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: visible;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 15px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1rem;
    }

    .header-links {
      display: flex;
      gap: 15px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .bot-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 15px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background 0.3s, transform 0.2s;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .bot-link:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .bot-link svg {
      width: 18px;
      height: 18px;
    }

    .content {
      padding: 30px;
      overflow: visible;
      width: 100%;
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }

    input[type="text"],
    input[type="password"],
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }

    .help-text {
      font-size: 0.875rem;
      color: #777;
      margin-top: 5px;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #667eea;
      font-weight: 600;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .error {
      background: #fee;
      border-left: 4px solid #c33;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      color: #c33;
    }

    .success {
      background: #efe;
      border-left: 4px solid #3c3;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      color: #2a2;
    }

    .results {
      margin-top: 30px;
    }

    .results-summary {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-around;
      text-align: center;
    }

    .summary-item {
      flex: 1;
    }

    .summary-number {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
    }

    .summary-label {
      font-size: 0.875rem;
      color: #777;
    }

    .results-table {
      width: 100%;
      min-width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: visible;
      table-layout: fixed;
    }

    #mediciList {
      overflow: visible;
      width: 100%;
    }

    .results {
      overflow: visible;
      width: 100%;
    }

    .results-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .results-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      user-select: none;
      position: relative;
      white-space: nowrap;
    }

    .results-table th:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .results-table th::after {
      content: ' ‚Üï';
      opacity: 0.3;
      font-size: 0.8rem;
      vertical-align: top;
    }

    .results-table th.sort-asc::after {
      content: ' ‚Üë';
      opacity: 1;
    }

    .results-table th.sort-desc::after {
      content: ' ‚Üì';
      opacity: 1;
    }

    /* Larghezze colonne */
    .results-table th:nth-child(1),
    .results-table td:nth-child(1) {
      width: 50px;
    }

    .results-table th:nth-child(2),
    .results-table td:nth-child(2) {
      width: 25%;
    }

    .results-table th:nth-child(3),
    .results-table td:nth-child(3) {
      width: 25%;
    }

    .results-table th:nth-child(4),
    .results-table td:nth-child(4) {
      width: 120px;
    }

    .results-table th:nth-child(5),
    .results-table td:nth-child(5) {
      width: auto;
    }

    .results-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 0.9rem;
    }

    .results-table tbody tr:hover {
      background: #f9f9f9;
    }

    .results-table tbody tr:last-child td {
      border-bottom: none;
    }

    .emoji-cell {
      font-size: 1.2rem;
      text-align: center;
      width: 50px;
    }

    .nome-cell {
      font-weight: 600;
      color: #333;
    }

    .results-table tbody tr {
      position: relative;
      cursor: pointer;
    }

    .tooltip {
      display: none;
      position: absolute;
      z-index: 1000;
      background: white;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      min-width: 300px;
      left: 50%;
      top: 100%;
      transform: translateX(-50%);
      margin-top: 5px;
    }

    .results-table tbody tr:hover .tooltip {
      display: block;
    }

    .tooltip-title {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1rem;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 5px;
    }

    .tooltip-row {
      display: flex;
      padding: 5px 0;
      font-size: 0.875rem;
    }

    .tooltip-label {
      font-weight: 600;
      color: #555;
      min-width: 140px;
    }

    .tooltip-value {
      color: #333;
    }

    .legend {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
    }

    .legend-title {
      font-weight: 600;
      margin-bottom: 10px;
    }

    .legend-item {
      display: inline-block;
      margin-right: 20px;
      font-size: 0.875rem;
    }

    .footer {
      text-align: center;
      padding: 20px;
      color: #777;
      font-size: 0.875rem;
      border-top: 1px solid #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü©∫ Ricerca Medici ASL Lazio</h1>
      <div class="header-links">
        <a href="/bot" class="bot-link">
          <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z" fill="white"/>
          </svg>
          Ricevi notifiche con Telegram Bot
        </a>
        <a href="/swagger" class="bot-link">
          <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 0C5.383 0 0 5.383 0 12s5.383 12 12 12c6.616 0 12-5.383 12-12S18.616 0 12 0zm0 1.144c5.995 0 10.856 4.86 10.856 10.856 0 5.995-4.86 10.856-10.856 10.856-5.996 0-10.856-4.86-10.856-10.856C1.144 6.004 6.004 1.144 12 1.144zM8.37 5.868a6.707 6.707 0 0 0-.423.005c-.983.056-1.573.517-1.735 1.472-.115.665-.096 1.348-.143 2.017-.013.35-.05.697-.115 1.038-.134.609-.397.798-1.016.83a2.65 2.65 0 0 0-.244.042v1.463c1.126.055 1.278.452 1.37 1.629.033.429-.013.858.015 1.287.018.406.073.808.156 1.2.259 1.075 1.307 1.435 2.575 1.218v-1.283c-.203 0-.383.005-.558-.014-.43-.037-.609-.366-.609-1.343 0-.388-.009-.775-.019-1.163-.013-.471-.038-.937-.189-1.385-.212-.549-.677-.77-1.253-.888.586-.12 1.041-.34 1.253-.888.151-.448.176-.914.189-1.385.01-.388.019-.775.019-1.163 0-.977.179-1.306.609-1.343a5.822 5.822 0 0 1 .558-.014V5.868h-.005zm7.26 0v1.283c.203 0 .383-.005.558.014.43.037.609.366.609 1.343 0 .388.009.775.019 1.163.013.471.038.937.189 1.385.212.549.676.77 1.253.888-.587.12-1.041.34-1.253.888-.151.448-.176.914-.189 1.385-.01.388-.019.775-.019 1.163 0 .977-.179 1.306-.609 1.343a5.822 5.822 0 0 1-.558.014v1.283c1.268.217 2.316-.143 2.575-1.218.083-.392.138-.794.156-1.2.028-.429-.018-.858.015-1.287.092-1.177.244-1.574 1.37-1.629v-1.463a2.65 2.65 0 0 0-.244-.042c-.619-.032-.882-.221-1.016-.83-.065-.341-.102-.688-.115-1.038-.047-.669-.028-1.352-.143-2.017-.162-.955-.752-1.416-1.735-1.472a6.707 6.707 0 0 0-.423-.005h-.005z" fill="white"/>
          </svg>
          Documentazione API
        </a>
      </div>
    </div>

    <div class="content">
      <form id="searchForm">
        <div class="form-row">
          <div class="form-group">
            <label for="tipo">Tipo medico</label>
            <select id="tipo" name="tipo" disabled required>
              <option value="Medicina generale">Medicina generale</option>
              <option value="Pediatra">Pediatra</option>
            </select>
          </div>

          <div class="form-group">
            <label for="asl">ASL</label>
            <select id="asl" name="asl" required>
              <option value="Tutte">Tutte</option>
              <option value="Roma 1">Roma 1</option>
              <option value="Roma 2">Roma 2</option>
              <option value="Roma 3">Roma 3</option>
              <option value="Roma 4">Roma 4</option>
              <option value="Roma 5">Roma 5</option>
              <option value="Roma 6">Roma 6</option>
              <option value="Frosinone">Frosinone</option>
              <option value="Latina">Latina</option>
              <option value="Rieti">Rieti</option>
              <option value="Viterbo">Viterbo</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="cap">CAP</label>
          <input type="text" id="cap" name="cap" placeholder="es. 00100, 00118, 00185">
          <p class="help-text">Inserisci uno o pi√π CAP separati da virgola</p>
        </div>

        <div class="form-group">
          <label for="cognomi">Cognomi</label>
          <input type="text" id="cognomi" name="cognomi" placeholder="es. ROSSI, BIANCHI, VERDI">
          <p class="help-text">Inserisci uno o pi√π cognomi separati da virgola</p>
        </div>

        <div class="form-group">
          <label for="nomi">Nomi</label>
          <input type="text" id="nomi" name="nomi" placeholder="es. MARIO, LUIGI, PAOLO">
          <p class="help-text">Inserisci uno o pi√π nomi separati da virgola</p>
        </div>

        <p class="help-text" style="margin-top: -10px; margin-bottom: 20px; color: #f59e0b; font-weight: 600;">* Richiesto almeno uno tra CAP, Cognomi o Nomi</p>

        <button type="submit" id="submitBtn">üîç Cerca</button>
      </form>

      <div id="loading" style="display: none;" class="loading">
        Ricerca in corso
      </div>

      <div id="error" style="display: none;" class="error"></div>

      <div id="results" style="display: none;" class="results">
        <div class="results-summary">
          <div class="summary-item">
            <div class="summary-number" id="totalCount">0</div>
            <div class="summary-label">Totali</div>
          </div>
          <div class="summary-item">
            <div class="summary-number" style="color: #22c55e;" id="liberiCount">0</div>
            <div class="summary-label">Assegnabili liberamente</div>
          </div>
          <div class="summary-item">
            <div class="summary-number" style="color: #f59e0b;" id="derogaCount">0</div>
            <div class="summary-label">Con deroga</div>
          </div>
          <div class="summary-item">
            <div class="summary-number" style="color: #ef4444;" id="altroCount">0</div>
            <div class="summary-label">Altro</div>
          </div>
        </div>

        <div id="mediciList"></div>

        <div class="legend">
          <div class="legend-title">Legenda:</div>
          <span class="legend-item">üü¢ Assegnazione libera</span>
          <span class="legend-item">üü† Assegnabile con deroga</span>
          <span class="legend-item">üî¥ Non assegnabile</span>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>MediciLazioASL - Sistema di ricerca medici disponibili</p>
      <p>Dati aggiornati dal portale Salute Lazio</p>
    </div>
  </div>

  <script>
    const form = document.getElementById('searchForm');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const results = document.getElementById('results');
    const submitBtn = document.getElementById('submitBtn');

    let currentData = null;
    let sortColumn = null;
    let sortDirection = 'asc';

    function getStatoEmoji(assegnabilita) {
      const stato = assegnabilita.toLowerCase();
      if (stato.includes('assegnazione libera')) return 'üü¢';
      if (stato.includes('deroga')) return 'üü†';
      if (stato.includes('non assegnabile')) return 'üî¥';
      return '‚ö™';
    }

    function showError(message) {
      error.textContent = message;
      error.style.display = 'block';
      results.style.display = 'none';
    }

    function hideError() {
      error.style.display = 'none';
    }

    function showLoading() {
      loading.style.display = 'block';
      submitBtn.disabled = true;
      hideError();
      results.style.display = 'none';
    }

    function hideLoading() {
      loading.style.display = 'none';
      submitBtn.disabled = false;
    }

    function sortData(column) {
      if (!currentData) return;

      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }

      currentData.results.sort((a, b) => {
        let aVal = a[column] || '';
        let bVal = b[column] || '';

        // Conversione a lowercase per stringhe
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();

        if (sortDirection === 'asc') {
          return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
        } else {
          return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
        }
      });

      renderTable(currentData);
    }

    function renderTable(data) {
      const mediciList = document.getElementById('mediciList');
      mediciList.innerHTML = '';

      const table = document.createElement('table');
      table.className = 'results-table';

      const columns = [
        { key: 'assegnabilita', label: '', isEmoji: true },
        { key: 'cognome', label: 'Cognome' },
        { key: 'nome', label: 'Nome' },
        { key: 'asl', label: 'ASL' },
        { key: 'assegnabilita', label: 'Stato' }
      ];

      table.innerHTML = `
        <thead>
          <tr>
            ${columns.map(col => {
              const sortClass = sortColumn === col.key ? `sort-${sortDirection}` : '';
              return `<th class="${sortClass}" data-column="${col.key}">${col.label}</th>`;
            }).join('')}
          </tr>
        </thead>
        <tbody>
            ${data.results.map(medico => {
              const emoji = getStatoEmoji(medico.assegnabilita);

              // Costruisci tooltip con tutti i dati disponibili
              let tooltipContent = `
                <div class="tooltip-title">Dettagli completi</div>
                ${medico.codiceFiscale ? `<div class="tooltip-row"><span class="tooltip-label">Codice Fiscale:</span><span class="tooltip-value">${medico.codiceFiscale}</span></div>` : ''}
                ${medico.email ? `<div class="tooltip-row"><span class="tooltip-label">Email:</span><span class="tooltip-value">${medico.email}</span></div>` : ''}
                ${medico.indirizzo ? `<div class="tooltip-row"><span class="tooltip-label">Indirizzo:</span><span class="tooltip-value">${medico.indirizzo}</span></div>` : ''}
                ${medico.luogo ? `<div class="tooltip-row"><span class="tooltip-label">Luogo:</span><span class="tooltip-value">${medico.luogo}</span></div>` : ''}
                ${medico.luogoNascita ? `<div class="tooltip-row"><span class="tooltip-label">Luogo Nascita:</span><span class="tooltip-value">${medico.luogoNascita}</span></div>` : ''}
                ${medico.identificativo ? `<div class="tooltip-row"><span class="tooltip-label">Identificativo:</span><span class="tooltip-value">${medico.identificativo}</span></div>` : ''}
                ${medico.codiceDistretto ? `<div class="tooltip-row"><span class="tooltip-label">Codice Distretto:</span><span class="tooltip-value">${medico.codiceDistretto}</span></div>` : ''}
                ${medico.descrizioneDistretto ? `<div class="tooltip-row"><span class="tooltip-label">Distretto:</span><span class="tooltip-value">${medico.descrizioneDistretto}</span></div>` : ''}
              `;

              return `
                <tr>
                  <td class="emoji-cell">${emoji}</td>
                  <td class="nome-cell">${medico.cognome}</td>
                  <td>${medico.nome}</td>
                  <td>${medico.asl}</td>
                  <td>${medico.assegnabilita}</td>
                  <td style="position: relative;">
                    <div class="tooltip">${tooltipContent}</div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        `;

      mediciList.appendChild(table);

      // Aggiungi event listener per il sorting
      table.querySelectorAll('th[data-column]').forEach(th => {
        th.addEventListener('click', () => {
          sortData(th.dataset.column);
        });
      });
    }

    function displayResults(data) {
      currentData = data;
      sortColumn = null;
      sortDirection = 'asc';

      // Calcola i contatori per categoria
      const liberi = data.results.filter(m => m.assegnabilita.toLowerCase().includes('assegnazione libera')).length;
      const deroga = data.results.filter(m => m.assegnabilita.toLowerCase().includes('deroga')).length;
      const altro = data.count - liberi - deroga;

      document.getElementById('totalCount').textContent = data.count;
      document.getElementById('liberiCount').textContent = liberi;
      document.getElementById('derogaCount').textContent = deroga;
      document.getElementById('altroCount').textContent = altro;

      if (data.results.length === 0) {
        document.getElementById('mediciList').innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">Nessun medico trovato con i criteri specificati.</p>';
      } else {
        renderTable(data);
      }

      results.style.display = 'block';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const cognomi = document.getElementById('cognomi').value
        .split(',')
        .map(c => c.trim().toUpperCase())
        .filter(c => c.length > 0);

      const cap = document.getElementById('cap').value
        .split(',')
        .map(c => c.trim())
        .filter(c => c.length > 0);

      const nomi = document.getElementById('nomi').value
        .split(',')
        .map(n => n.trim().toUpperCase())
        .filter(n => n.length > 0);

      const asl = document.getElementById('asl').value;
      const tipo = document.getElementById('tipo').value;

      if (cognomi.length === 0 && cap.length === 0 && nomi.length === 0) {
        showError('Inserisci almeno uno tra CAP, Cognomi o Nomi.');
        return;
      }

      showLoading();

      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({
            cognomi,
            asl,
            tipo,
            cap,
            nomi
          })
        });

        const data = await response.json();

        hideLoading();

        if (!response.ok) {
          if (response.status === 401) {
            // Non autenticato - redirect a login
            window.location.href = '/login';
            return;
          } else {
            showError(data.error || 'Errore durante la ricerca.');
          }
          return;
        }

        if (!data.success) {
          showError(data.error || 'Errore durante la ricerca.');
          return;
        }

        displayResults(data);
      } catch (err) {
        hideLoading();
        showError('Errore di connessione. Riprova pi√π tardi.');
        console.error('Search error:', err);
      }
    });
  </script>
</body>
</html>
